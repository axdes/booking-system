
 <script>
  function renderCalendar() {
    console.log('üìÖ renderCalendar –≤—ã–∑–≤–∞–Ω');

    const cal = document.getElementById('calendar');
    if (!cal) return;
    cal.innerHTML = '';

    const nav = document.createElement('div');
    nav.style.display = 'flex';
    nav.style.justifyContent = 'space-between';
    nav.style.alignItems = 'center';
    nav.style.marginBottom = '0.5rem';

    const btnPrev = document.createElement('button');
    btnPrev.textContent = '‚Üê–ü—Ä–µ–¥';
    btnPrev.onclick = prevMonth;
    if (isAtMin()) btnPrev.disabled = true;
    nav.appendChild(btnPrev);

    const dateObj = new Date(currentYear, currentMonth, 1, 12, 0, 0);
    const label = dateObj.toLocaleString('ru-RU', { month: 'long', year: 'numeric' });
    const spanTitle = document.createElement('span');
    spanTitle.textContent = label;
    spanTitle.style.fontWeight = 'bold';
    nav.appendChild(spanTitle);

    const btnNext = document.createElement('button');
    btnNext.textContent = '–°–ª–µ–¥‚Üí';
    btnNext.onclick = nextMonth;
    if (isAtMax()) btnNext.disabled = true;
    nav.appendChild(btnNext);

    cal.appendChild(nav);

    const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    const headerRow = document.createElement('div');
    headerRow.className = 'calendar-header';
    dayNames.forEach(dn => {
      const hd = document.createElement('div');
      hd.className = 'cal-header-cell';
      hd.textContent = dn;
      headerRow.appendChild(hd);
    });
    cal.appendChild(headerRow);

    const grid = document.createElement('div');
    grid.className = 'calendar-grid';
    cal.appendChild(grid);

    let firstDay = new Date(currentYear, currentMonth, 1).getDay();
    let offset = (firstDay === 0 ? 6 : (firstDay - 1));
    for (let i = 0; i < offset; i++) {
      const empty = document.createElement('div');
      empty.className = 'cal-cell empty';
      grid.appendChild(empty);
    }

    const todayMid = new Date();
    todayMid.setHours(0, 0, 0, 0);
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

    for (let d = 1; d <= daysInMonth; d++) {
      const cell = document.createElement('div');
      cell.className = 'cal-cell';
      const dayDate = new Date(currentYear, currentMonth, d, 12, 0, 0);
      const ds = dayDate.toISOString().split('T')[0];

      const numDiv = document.createElement('div');
      numDiv.className = 'cal-daynum';
      numDiv.textContent = d;

      const priceDiv = document.createElement('div');
      priceDiv.className = 'cal-price';

      let base = null;
      if (dayDate >= todayMid && !window.busyDates.includes(ds)) {
        let wd = dayDate.getDay();
        if ([1, 2, 3, 4].includes(wd)) base = window.config.weekday_price || 0;
        else if (wd === 5) base = window.config.friday_price || 0;
        else if (wd === 6) base = window.config.saturday_price || 0;
        else base = window.config.sunday_price || 0;

        if (window.myPlan === 'max') base += 100;
        else if (window.myPlan === 'custom') {
          base -= (window.config.custom_discount || 0);
          window.customSelected.forEach(id => {
            const op = window.optionsArr.find(x => x.id === id);
            if (op && !op.isExtra) base += op.price;
          });
          if (base < 0) base = 0;
        }
      }

      priceDiv.textContent = (base !== null) ? (base + ' —Ä.') : '-';

      if (dayDate < todayMid || window.busyDates.includes(ds)) {
        cell.classList.add('busy');
        cell.style.background = '#ddd';
        cell.style.color = '#888';
      } else {
        cell.addEventListener('click', () => selectDate(ds));
      }

      if (inRange(ds)) cell.classList.add('selected');

      cell.appendChild(numDiv);
      cell.appendChild(priceDiv);
      grid.appendChild(cell);
    }
  }

  function prevMonth() {
    if (isAtMin()) return;
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    renderCalendar();
  }

  function nextMonth() {
    if (isAtMax()) return;
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    renderCalendar();
  }

  function isAtMin() {
    return (currentYear < minYear) || (currentYear === minYear && currentMonth <= minMonth);
  }

  function isAtMax() {
    return (currentYear > maxYear) || (currentYear === maxYear && currentMonth >= maxMonth);
  }

  function inRange(ds) {
    if (window.selectedDates.length < 1) return false;
    if (window.selectedDates.length === 1) return ds === window.selectedDates[0];
    const [s, e] = window.selectedDates;
    return (ds >= s && ds <= e);
  }

  function selectDate(ds) {
    if (window.selectedDates.length === 2) {
      window.selectedDates = [];
    } else if (window.selectedDates.length === 1) {
      if (window.selectedDates[0] === ds) {
        window.selectedDates = [];
        updateRangeText();
        renderCalendar();
        showCalendarPriceInfo();
        return;
      }
    }
    window.selectedDates.push(ds);
    window.selectedDates.sort();

    if (window.selectedDates.length === 2) {
      if (!checkRange(window.selectedDates[0], window.selectedDates[1])) {
        document.getElementById('dateError').style.display = 'block';
        document.getElementById('dateError').textContent = '–í –¥–∏–∞–ø–∞–∑–æ–Ω–µ –µ—Å—Ç—å –∑–∞–Ω—è—Ç—ã–µ/–ø—Ä–æ—à–µ–¥—à–∏–µ –¥–∞—Ç—ã!';
        window.selectedDates = [];
        document.getElementById('proceedBtn').disabled = true;
      } else {
        document.getElementById('dateError').style.display = 'none';
        document.getElementById('proceedBtn').disabled = false;
      }
    } else {
      document.getElementById('dateError').style.display = 'none';
      document.getElementById('proceedBtn').disabled = false;
    }

    updateRangeText();
    renderCalendar();
  }

  function checkRange(start, end) {
    let cIn = new Date(start + 'T12:00:00');
    let cOut = new Date(end + 'T12:00:00');
    const todayMid = new Date(); todayMid.setHours(0, 0, 0, 0);
    while (cIn < cOut) {
      let ds = cIn.toISOString().split('T')[0];
      if (window.busyDates.includes(ds)) return false;
      if (cIn < todayMid) return false;
      cIn.setDate(cIn.getDate() + 1);
    }
    return true;
  }

  function updateRangeText() {
    const rng = document.getElementById('selectedRange');
    if (!rng) return;
    const formatDate = (ds) => {
      const d = new Date(ds + 'T12:00:00');
      return d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
    };
    if (window.selectedDates.length === 1) {
      const checkin = formatDate(window.selectedDates[0]);
      const checkoutDate = new Date(window.selectedDates[0] + 'T12:00:00');
      checkoutDate.setDate(checkoutDate.getDate() + 1);
      const checkout = checkoutDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
      rng.textContent = `–í—ã –≤—ã–±—Ä–∞–ª–∏ ${checkin}: –∑–∞–µ–∑–¥ –≤ 15:00, –≤—ã–µ–∑–¥ ${checkout} –≤ 12:00`;
    } else if (window.selectedDates.length === 2) {
      const checkin = formatDate(window.selectedDates[0]);
      const checkoutDate = new Date(window.selectedDates[1] + 'T12:00:00');
      checkoutDate.setDate(checkoutDate.getDate() + 1);
      const checkout = checkoutDate.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
      rng.textContent = `–í—ã –≤—ã–±—Ä–∞–ª–∏ —Å ${checkin} –¥–æ ${checkout}`;
    } else {
      rng.textContent = '';
    }
  }

  function showCalendarPriceInfo() {
    const infoDiv = document.getElementById('calendarPriceInfo');
    if (!infoDiv || window.selectedDates.length === 0) {
      infoDiv.style.display = 'none';
      return;
    }
    let start = new Date(window.selectedDates[0] + 'T12:00:00');
    let end = new Date(window.selectedDates[1] || window.selectedDates[0] + 'T12:00:00');
    let days = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
    let total = 0;
    for (let i = 0; i < days; i++) {
      let d = new Date(start);
      d.setDate(start.getDate() + i);
      const wd = d.getDay();
      let base = 0;
      if ([1, 2, 3, 4].includes(wd)) base = window.config.weekday_price || 0;
      else if (wd === 5) base = window.config.friday_price || 0;
      else if (wd === 6) base = window.config.saturday_price || 0;
      else base = window.config.sunday_price || 0;
      if (window.myPlan === 'max') base += 100;
      else if (window.myPlan === 'custom') base -= (window.config.custom_discount || 0);
      if (base < 0) base = 0;
      total += base;
    }
    const prepayment = Math.round(total * 0.3);
    let text = `–ü—Ä–∏–º–µ—Ä–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: ${total} BYN<br>–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞: ${prepayment} BYN (30%)`;
    if (window.myPlan === 'max') {
      text += `<br><em>–í—ã —ç–∫–æ–Ω–æ–º–∏—Ç–µ –¥–æ 150 BYN –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å —Ä—É—á–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –æ–ø—Ü–∏–π</em>`;
    }
    infoDiv.innerHTML = text;
    infoDiv.style.display = 'block';
  }
</script>
